<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submit Post | SEO India Online Free Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" href="https://seoindiaonline.com/wp-content/uploads/2025/04/logo.png">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
nav{background:#062f4f;padding:12px;text-align:center}
nav a{color:#fff;margin:0 12px;font-weight:bold;text-decoration:none}
.container{max-width:1200px;margin:30px auto;background:#fff;padding:20px}
.editor-wrap{display:flex;gap:20px}
textarea{width:50%;height:420px;font-family:monospace}
.preview{width:50%;border:1px solid #ccc;padding:15px;background:#fafafa;overflow:auto}
button{margin-top:15px;padding:10px 20px;background:#0a3d62;color:#fff;border:none;cursor:pointer}
.error{color:#c0392b;font-size:14px;margin-bottom:10px}
</style>
</head>

<body>

<nav>
  <a href="index.html">Home</a>
  <a href="posts.html">Posts</a>
  <a href="submit-post.html">Submit</a>
</nav>

<div class="container">
  <h1>Submit Blog Post</h1>

  <div id="error" class="error"></div>

  <input id="title" placeholder="Post Title *"
         style="width:100%;padding:10px;margin-bottom:10px">

  <div class="editor-wrap">
    <textarea id="content"
      placeholder="Write content (HTML / Markdown / BBCode). Images & videos allowed."></textarea>
    <div class="preview" id="preview">
      <em>Live preview will appear here‚Ä¶</em>
    </div>
  </div>

  <button id="publish">Publish Post</button>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  addDoc, collection, serverTimestamp,
  query, where, getDocs
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const errorBox = document.getElementById("error");
let currentUser = null;

/* üîí LOGIN REQUIRED */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  currentUser = user;

  // üö® HARD BLOCK: author name must exist
  if (!user.displayName || !user.displayName.trim()) {
    errorBox.textContent =
      "Your profile name is missing. Please re-register or contact support.";
    document.getElementById("publish").disabled = true;
  }
});

/* ---------- SLUG ---------- */
const slugify = t =>
  t.toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");

async function uniqueSlug(base){
  let s = base, i = 1;
  while(true){
    const q = query(collection(db,"posts"), where("slug","==",s));
    if((await getDocs(q)).empty) return s;
    s = `${base}-${++i}`;
  }
}

/* ---------- SAFE PARSER ---------- */
function parseContent(text){
  let html = text;

  html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");

  html = html.replace(/^### (.*)$/gim,"<h3>$1</h3>");
  html = html.replace(/^## (.*)$/gim,"<h2>$1</h2>");
  html = html.replace(/\*\*(.*?)\*\*/gim,"<strong>$1</strong>");
  html = html.replace(/\*(.*?)\*/gim,"<em>$1</em>");

  html = html.replace(
    /\[url=(.*?)\](.*?)\[\/url\]/gim,
    "<a href='$1' target='_blank' rel='nofollow'>$2</a>"
  );

  html = html.replace(/^\- (.*)$/gim,"<li>$1</li>");
  html = html.replace(/(<li>.*<\/li>)/gims,"<ul>$1</ul>");

  html = html
    .split(/\n\s*\n/)
    .map(block => {
      if (block.trim().startsWith("<")) return block;
      return `<p>${block.replace(/\n/g,"<br>")}</p>`;
    })
    .join("");

  return html;
}

/* ---------- LIVE PREVIEW ---------- */
content.addEventListener("input",()=>{
  preview.innerHTML = parseContent(content.value);
});

/* ---------- PUBLISH ---------- */
publish.onclick = async () => {
  errorBox.textContent = "";

  const titleVal = title.value.trim();
  const contentVal = content.value.trim();

  // ‚ùå Title required
  if (!titleVal) {
    errorBox.textContent = "Post title is required.";
    return;
  }

  // ‚ùå Content length
  if (contentVal.length < 200) {
    errorBox.textContent = "Minimum 200 words required.";
    return;
  }

  // ‚ùå Author missing (double safety)
  if (!currentUser || !currentUser.displayName) {
    errorBox.textContent =
      "Author name missing. Cannot publish post.";
    return;
  }

  const slug = await uniqueSlug(slugify(titleVal));

  await addDoc(collection(db,"posts"),{
    title: titleVal,
    slug,
    content: parseContent(contentVal),
    authorName: currentUser.displayName,
    createdAt: serverTimestamp(),
    status: "published"
  });

  alert("Post published successfully");
  location.href = "index.html";
};
</script>

</body>
</html>
